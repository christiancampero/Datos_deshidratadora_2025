<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de Temperaturas - Fray Bentos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      color: #222;
      text-align: center;
      padding: 20px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 80%;
    }
    th, td {
      border: 1px solid #888;
      padding: 8px;
    }
    th {
      background: #0066cc;
      color: #fff;
    }
    tr:nth-child(even) {
      background: #e9e9e9;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Generador de Temperaturas - Fray Bentos</h1>
  <p>Env√≠o de datos a ThingSpeak cada 10 segundos.</p>
  <button id="descargar">Descargar JSON</button>
  <table id="tabla">
    <thead>
      <tr>
        <th>Hora</th>
        <th>Temp. Externa (¬∞C)</th>
        <th>Temp. Interna (¬∞C)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const ACCUWEATHER_API_KEY = "YOUR_ACCUWEATHER_API_KEY";
    const THINGSPEAK_WRITE_API_KEY = "YOUR_THINGSPEAK_WRITE_API_KEY";
    const LOCATION_KEY = "331168"; // Fray Bentos, Uruguay

    let datosGenerados = [];

    async function obtenerTemperaturaExterna() {
      try {
        const url = `https://dataservice.accuweather.com/currentconditions/v1/${LOCATION_KEY}?apikey=${ACCUWEATHER_API_KEY}&details=true`;
        const respuesta = await fetch(url);
        const datos = await respuesta.json();
        const tempC = datos[0].Temperature.Metric.Value;
        console.log("‚úÖ Temperatura externa obtenida desde AccuWeather:", tempC, "¬∞C");
        return tempC;
      } catch (error) {
        console.error("‚ùå Error obteniendo datos de AccuWeather:", error);
        return null;
      }
    }

    async function enviarAThingSpeak(tempInterna, tempExterna) {
      const url = `https://api.thingspeak.com/update?api_key=${THINGSPEAK_WRITE_API_KEY}&field1=${tempInterna}&field6=${tempExterna}`;
      try {
        const respuesta = await fetch(url, { method: "GET" });
        const resultado = await respuesta.text();
        console.log(`üì§ Datos enviados a ThingSpeak ‚Üí Entry ID: ${resultado}`);
      } catch (error) {
        console.error("‚ùå Error al enviar datos a ThingSpeak:", error);
      }
    }

    function agregarFilaTabla(tempExt, tempInt) {
      const tabla = document.querySelector("#tabla tbody");
      const fila = document.createElement("tr");
      const hora = new Date().toLocaleTimeString();
      fila.innerHTML = `
        <td>${hora}</td>
        <td>${tempExt ? tempExt.toFixed(2) : 'N/A'}</td>
        <td>${tempInt ? tempInt.toFixed(2) : 'N/A'}</td>
      `;
      tabla.appendChild(fila);
    }

    async function cicloDeEnvio() {
      console.log("\n‚è±Ô∏è Iniciando ciclo de actualizaci√≥n...");
      const tempExt = await obtenerTemperaturaExterna();
      if (tempExt === null) {
        console.warn("‚ö†Ô∏è No se pudo obtener la temperatura externa. Saltando env√≠o.");
        return;
      }
      const tempInt = tempExt + 3;
      console.log(`üå°Ô∏è Temperatura externa: ${tempExt}¬∞C | interna: ${tempInt}¬∞C`);

      await enviarAThingSpeak(tempInt, tempExt);

      datosGenerados.push({
        timestamp: new Date().toISOString(),
        temperatura_externa: tempExt,
        temperatura_interna: tempInt
      });

      agregarFilaTabla(tempExt, tempInt);
    }

    // Descargar datos en JSON
    document.getElementById("descargar").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(datosGenerados, null, 2)], { type: "application/json" });
      const enlace = document.createElement("a");
      enlace.href = URL.createObjectURL(blob);
      enlace.download = "datos_temperatura.json";
      enlace.click();
    });

    // Inicia el env√≠o cada 10 segundos
    cicloDeEnvio();
    setInterval(cicloDeEnvio, 10000);
  </script>
</body>
</html>
